//
// Copyright (c) 2017 Related Code - http://relatedcode.com
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

#import "RCMessage.h"

@implementation RCMessage

#pragma mark - Initialization methods

//-------------------------------------------------------------------------------------------------------------------------------------------------
- (id)initWithStatus:(NSString *)text
//-------------------------------------------------------------------------------------------------------------------------------------------------
{
	self = [super init];
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.type = RC_TYPE_STATUS;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.incoming = NO;
	self.outgoing = NO;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.text = [NSString stringWithString:text];
	//---------------------------------------------------------------------------------------------------------------------------------------------
	return self;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------
- (id)initWithText:(NSString *)text incoming:(BOOL)incoming
//-------------------------------------------------------------------------------------------------------------------------------------------------
{
	self = [super init];
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.type = RC_TYPE_TEXT;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.incoming = incoming;
	self.outgoing = !incoming;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.text = [NSString stringWithString:text];
	//---------------------------------------------------------------------------------------------------------------------------------------------
	return self;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------
- (id)initWithEmoji:(NSString *)text incoming:(BOOL)incoming
//-------------------------------------------------------------------------------------------------------------------------------------------------
{
	self = [super init];
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.type = RC_TYPE_EMOJI;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.incoming = incoming;
	self.outgoing = !incoming;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.text = [NSString stringWithString:text];
	//---------------------------------------------------------------------------------------------------------------------------------------------
	return self;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------
- (id)initWithPicture:(UIImage *)image width:(NSInteger)width height:(NSInteger)height incoming:(BOOL)incoming
//-------------------------------------------------------------------------------------------------------------------------------------------------
{
	self = [super init];
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.type = RC_TYPE_PICTURE;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.incoming = incoming;
	self.outgoing = !incoming;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.picture_image = image;
	self.picture_width = width;
	self.picture_height = height;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	return self;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------
- (id)initWithVideo:(NSString *)path durarion:(NSInteger)duration incoming:(BOOL)incoming
//-------------------------------------------------------------------------------------------------------------------------------------------------
{
	self = [super init];
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.type = RC_TYPE_VIDEO;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.incoming = incoming;
	self.outgoing = !incoming;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.video_path = path;
	self.video_duration = duration;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	return self;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------
- (id)initWithAudio:(NSString *)path durarion:(NSInteger)duration incoming:(BOOL)incoming
//-------------------------------------------------------------------------------------------------------------------------------------------------
{
	self = [super init];
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.type = RC_TYPE_AUDIO;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.incoming = incoming;
	self.outgoing = !incoming;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.audio_path = path;
	self.audio_duration = duration;
	self.audio_status = RC_AUDIOSTATUS_STOPPED;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	return self;
}

//-------------------------------------------------------------------------------------------------------------------------------------------------
- (id)initWithLatitude:(CLLocationDegrees)latitude longitude:(CLLocationDegrees)longitude incoming:(BOOL)incoming
			completion:(void (^)(void))completion
//-------------------------------------------------------------------------------------------------------------------------------------------------
{
	self = [super init];
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.type = RC_TYPE_LOCATION;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.incoming = incoming;
	self.outgoing = !incoming;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.latitude = latitude;
	self.longitude = longitude;
	//---------------------------------------------------------------------------------------------------------------------------------------------

	//---------------------------------------------------------------------------------------------------------------------------------------------
	self.status = RC_STATUS_LOADING;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	MKCoordinateRegion region;
	region.center.latitude = self.latitude;
	region.center.longitude = self.longitude;
	region.span.latitudeDelta = 0.005;
	region.span.longitudeDelta = 0.005;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	MKMapSnapshotOptions *options = [[MKMapSnapshotOptions alloc] init];
	options.region = region;
	options.size = CGSizeMake([RCMessages locationBubbleWidth], [RCMessages locationBubbleHeight]);
	options.scale = [UIScreen mainScreen].scale;
	//---------------------------------------------------------------------------------------------------------------------------------------------
	MKMapSnapshotter *snapshotter = [[MKMapSnapshotter alloc] initWithOptions:options];
	[snapshotter startWithQueue:dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0)
			  completionHandler:^(MKMapSnapshot *snapshot, NSError *error)
	{
		if (snapshot != nil)
		{
			UIGraphicsBeginImageContextWithOptions(snapshot.image.size, YES, snapshot.image.scale);
			{
				[snapshot.image drawAtPoint:CGPointZero];

				MKAnnotationView *pin = [[MKPinAnnotationView alloc] initWithAnnotation:nil reuseIdentifier:nil];
				CGPoint point = [snapshot pointForCoordinate:CLLocationCoordinate2DMake(self.latitude, self.longitude)];
				point.x += pin.centerOffset.x - (pin.bounds.size.width / 2);
				point.y += pin.centerOffset.y - (pin.bounds.size.height / 2);
				[pin.image drawAtPoint:point];

				self.location_thumbnail = UIGraphicsGetImageFromCurrentImageContext();
			}
			UIGraphicsEndImageContext();

			self.status = RC_STATUS_SUCCEED;
			dispatch_async(dispatch_get_main_queue(), ^{
				if (completion != nil) completion();
			});
		}
	}];
	//---------------------------------------------------------------------------------------------------------------------------------------------

	//---------------------------------------------------------------------------------------------------------------------------------------------
	return self;
}

@end
